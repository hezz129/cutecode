<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¾¿åˆ©åº—é¹°çœ¼ç³»ç»Ÿ</title>
    <!-- é˜²æ­¢ç¼“å­˜ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- é˜²æ­¢æœç´¢å¼•æ“ç´¢å¼• -->
    <meta name="robots" content="noindex, nofollow">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-content {
            display: none;
            width: 100%;
            max-width: 1600px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-top: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .description {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            margin-right: 5px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Excelè¡¨æ ¼ç›¸å…³æ ·å¼ */
        .upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            background: #f8fafc;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        .upload-section:hover {
            background: #e8f4ff;
            border-color: #2980b9;
        }

        .upload-icon {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s;
            margin-top: 15px;
        }

        .upload-btn:hover {
            background: #2980b9;
        }

        .file-name {
            margin-top: 15px;
            color: #7f8c8d;
        }

        .table-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            align-items: center;
        }

        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .filter-input {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-width: 150px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            /* position: relative; */
        }

        th {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background-color: #2980b9;
        }

        th .sort-icon {
            margin-left: 5px;
            font-size: 12px;
        }

        .column-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 5px;
            cursor: pointer;
            font-size: 12px;
        }

        /* ç™»å½•ç›¸å…³æ ·å¼ */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-title {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .login-input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .login-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: #2980b9;
        }

        .login-error {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
        }


        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e8f4ff;
        }

        .expired {
            color: #e74c3c;
            font-weight: 500;
        }

        .warning {
            color: #f39c12;
            font-weight: 500;
        }

        .normal {
            color: #27ae60;
            font-weight: 500;
        }

        .qr-cell {
            text-align: center;
            width: 100px;
        }

        .qr-code {
            display: inline-block;
            width: 80px;
            height: 80px;
            background: white;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .qr-code:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .qr-code:active {
            transform: scale(0.95);
        }

        .sheet-selector {
            margin: 15px 0;
            display: flex;
            align-items: center;
        }

        .sheet-selector label {
            margin-right: 10px;
            font-weight: 500;
            color: #2c3e50;
        }

        .sheet-selector select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .instructions {
            background: #e8f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }

        .instructions h3 {
            color: #3498db;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .instructions ul {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            color: #2c3e50;
            line-height: 1.5;
        }

        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            text-align: center;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .download-btn {
            background: #27ae60;
            color: white;
        }

        .download-btn:hover {
            background: #219653;
        }

        .toggle-column-btn {
            background: #95a5a6;
            color: white;
        }

        .toggle-column-btn:hover {
            background: #7f8c8d;
        }

        .filter-btn {
            background: #9b59b6;
            color: white;
        }

        .filter-btn:hover {
            background: #8e44ad;
        }

        .decode-status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 6px;
            background: #2c3e50;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .decode-status.show {
            opacity: 1;
        }

        .decode-status.success {
            background: #27ae60;
        }

        .decode-status.error {
            background: #e74c3c;
        }

        .hidden-column {
            display: none;
        }

        /* æ‰«æå™¨ç›¸å…³æ ·å¼ */
        .scanner-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            background: #000;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanning-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid #3498db;
            box-sizing: border-box;
            pointer-events: none;
        }

        .scan-line {
            position: absolute;
            height: 2px;
            width: 100%;
            background: #3498db;
            top: 50%;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% {
                top: 10%;
            }

            100% {
                top: 90%;
            }
        }

        .scanner-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            min-width: 120px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .search-section {
            width: 100%;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .status-message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            text-align: center;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .permission-help {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }

        .permission-help h3 {
            margin-bottom: 10px;
            color: #856404;
        }

        .permission-help ul {
            padding-left: 20px;
            margin-top: 10px;
        }

        .permission-help li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .voice-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .voice-select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-width: 200px;
        }

        .column-visibility {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .column-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .column-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Edgeæµè§ˆå™¨ç‰¹å®šä¿®å¤ */
        .edge-fix {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .edge-fix h3 {
            color: #1565c0;
            margin-bottom: 10px;
        }

        .edge-fix ol {
            padding-left: 20px;
        }

        .edge-fix li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        /* æ‰«ææ¨¡å¼é€‰æ‹©å™¨æ ·å¼ */
        .scan-mode-selector {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .scan-mode-btn {
            padding: 10px 20px;
            border: 2px solid #3498db;
            border-radius: 6px;
            background: white;
            color: #3498db;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .scan-mode-btn.active {
            background: #3498db;
            color: white;
        }

        .scan-mode-btn:hover {
            background: #2980b9;
            color: white;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            th,
            td {
                padding: 8px 10px;
                font-size: 14px;
            }

            .table-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .scanner-controls {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                margin-bottom: 5px;
                padding: 10px 15px;
                font-size: 14px;
            }

            .video-container {
                min-height: 250px;
            }

            .instructions,
            .permission-help,
            .edge-fix {
                font-size: 14px;
            }

            .upload-section {
                padding: 20px;
            }

            .upload-btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .scan-mode-selector {
                flex-direction: column;
                align-items: center;
            }

            .scan-mode-btn {
                width: 100%;
                text-align: center;
            }
        }

        /* æ‘„åƒå¤´æƒé™è¯·æ±‚æŒ‰é’® */
        .permission-request {
            background: #ff9800;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 10px 0;
            transition: background 0.3s;
        }

        .permission-request:hover {
            background: #f57c00;
        }

        .camera-permission {
            text-align: center;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-screen">
        <div class="login-container">
            <h2 class="login-title">ç³»ç»Ÿç™»å½•</h2>
            <form id="login-form" class="login-form">
                <input type="text" id="username" class="login-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                <input type="password" id="password" class="login-input" placeholder="è¯·è¾“å…¥å¯†ç " required>
                <button type="submit" class="login-btn">ç™»å½•</button>
                <div id="login-error" class="login-error"></div>
            </form>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ - ç™»å½•åæ˜¾ç¤º -->
    <div class="main-content">
        <h1>ä¾¿åˆ©åº—é¹°çœ¼ç³»ç»Ÿ</h1>
        <p class="description">å“ˆå¯†å…¬å¸</p>

        <div class="container">
            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="tabs">
                <div class="tab active" data-tab="excel-tab">Excelè¡¨æ ¼</div>
                <div class="tab" data-tab="scanner-tab">å·¥å…·é€‰æ‹©</div>
            </div>

            <!-- Excelè¡¨æ ¼æ ‡ç­¾é¡µ -->
            <div id="excel-tab" class="tab-content active">
                <div class="upload-section" id="drop-area">
                    <div class="upload-icon">ğŸ“Š</div>
                    <p>æ‹–æ”¾Excelæ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸Šä¼ </p>
                    <input type="file" id="file-input" class="file-input" accept=".xlsx, .xls">
                    <button class="upload-btn" id="upload-btn">é€‰æ‹©Excelæ–‡ä»¶</button>
                    <p class="file-name" id="file-name">æœªé€‰æ‹©æ–‡ä»¶</p>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨å¤„ç†Excelæ–‡ä»¶ï¼Œè¯·ç¨å€™...</p>
                </div>

                <div class="message info">
                    <strong>æç¤ºï¼š</strong> ç³»ç»Ÿä¼šæ ¹æ®"æ¡ç å†…å®¹"åˆ—çš„å†…å®¹è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„æ¡å½¢ç ï¼Œä½¿ç”¨æ‰«ææªå¯æ‰«æè¯†åˆ«
                </div>

                <div class="sheet-selector">
                    <label for="sheet-select">é€‰æ‹©å·¥ä½œè¡¨:</label>
                    <select id="sheet-select"></select>
                </div>

                <div class="table-controls">
                    <div class="filter-controls">
                        <input type="text" id="global-filter" class="filter-input" placeholder="å…¨å±€æœç´¢...">
                        <button class="action-btn filter-btn" id="apply-filter">åº”ç”¨ç­›é€‰</button>
                        <button class="action-btn" id="clear-filter">æ¸…é™¤ç­›é€‰</button>
                    </div>

                    <button class="action-btn toggle-column-btn" id="toggle-columns-btn">æ˜¾ç¤º/éšè—åˆ—</button>
                </div>

                <div class="column-visibility" id="column-visibility" style="display: none;">
                    <h3>åˆ—æ˜¾ç¤ºè®¾ç½®</h3>
                    <div class="column-checkboxes" id="column-checkboxes">
                        <!-- åˆ—å¤é€‰æ¡†å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="voice-controls">
                    <label for="voice-select">é€‰æ‹©è¯­éŸ³:</label>
                    <select id="voice-select" class="voice-select"></select>
                </div>

                <div class="table-container">
                    <table id="data-table">
                        <thead id="table-header">
                            <!-- è¡¨å¤´å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </thead>
                        <tbody id="table-body">
                            <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>

                <div class="instructions">
                    <h3>ä½¿ç”¨è¯´æ˜</h3>
                    <ul>
                        <li>æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼çš„Excelæ–‡ä»¶</li>
                        <li>ä¸Šä¼ åä¼šè‡ªåŠ¨è§£æå¹¶æ˜¾ç¤ºç¬¬ä¸€ä¸ªå·¥ä½œè¡¨çš„å†…å®¹</li>
                        <li>ç³»ç»Ÿä¼šæ ¹æ®"æ¡ç å†…å®¹"åˆ—çš„å†…å®¹è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„æ¡å½¢ç </li>
                        <li>ä½¿ç”¨æ‰«ææªå¯ä»¥æ‰«æè¯†åˆ«æ¡ç å†…å®¹</li>
                        <li>ä½¿ç”¨è¡¨å¤´ä¸‹æ‹‰èœå•å¯ä»¥ç­›é€‰å’Œæ’åºæ•°æ®</li>
                        <li>ä½¿ç”¨"æ˜¾ç¤º/éšè—åˆ—"æŒ‰é’®å¯ä»¥æ§åˆ¶åˆ—çš„å¯è§æ€§</li>
                        <li>ä½¿ç”¨å…¨å±€æœç´¢æ¡†å¯ä»¥ç­›é€‰è¡¨æ ¼å†…å®¹</li>
                    </ul>
                </div>
            </div>

            <!-- æ‰«æå™¨æ ‡ç­¾é¡µ -->
            <div id="scanner-tab" class="tab-content">
                <!-- æ‰«ææ–¹å¼é€‰æ‹©å™¨ -->
                <div class="scan-method-selector">
                    <button class="method-btn active" data-method="camera">æ‘„åƒå¤´æ‰«æ</button>
                    <button class="method-btn" data-method="scanner">æ‰«ææªè¾“å…¥</button>
                </div>

                <!-- æ‘„åƒå¤´æ‰«æåŒºåŸŸ -->
                <div id="camera-scan-area" class="scan-area">
                    <div class="camera-permission">
                        <h3>æ‘„åƒå¤´è®¿é—®æƒé™</h3>
                        <p>è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å…è®¸è®¿é—®æ‘„åƒå¤´</p>
                        <button id="permission-btn" class="permission-request">å…è®¸æ‘„åƒå¤´è®¿é—®</button>
                    </div>

                    <div class="scanner-section">
                        <!-- æ·»åŠ æ‰«ææ¨¡å¼é€‰æ‹©å™¨ -->
                        <div class="scan-mode-selector">
                            <button class="scan-mode-btn active" data-mode="auto">è‡ªåŠ¨è¯†åˆ«</button>
                            <button class="scan-mode-btn" data-mode="qr">äºŒç»´ç </button>
                            <button class="scan-mode-btn" data-mode="barcode">æ¡å½¢ç </button>
                        </div>

                        <div class="video-container" id="video-container">
                            <div id="camera-placeholder">æ‘„åƒå¤´æœªå¯åŠ¨</div>
                            <video id="video" playsinline style="display: none;"></video>
                            <div class="scanning-overlay" style="display: none;">
                                <div class="scan-line"></div>
                            </div>
                        </div>

                        <div class="scanner-controls">
                            <button id="start-btn" class="btn btn-primary">å¼€å§‹æ‰«æ</button>
                            <button id="stop-btn" class="btn btn-danger" disabled>åœæ­¢æ‰«æ</button>
                            <button id="switch-camera" class="btn btn-success">åˆ‡æ¢æ‘„åƒå¤´</button>
                        </div>
                    </div>
                </div>

                <!-- æ‰«ææªè¾“å…¥åŒºåŸŸ -->
                <div id="scanner-input-area" class="scan-area" style="display: none;">
                    <div class="scanner-input-section">
                        <h3>æ‰«ææªè¾“å…¥</h3>
                        <p>è¯·å°†å…‰æ ‡æ”¾åœ¨è¾“å…¥æ¡†ä¸­ï¼Œç„¶åç”¨æ‰«ææªæ‰«æå•†å“æ¡ç </p>
                        <input type="text" id="scanner-input" class="scanner-input" placeholder="æ‰«ææªè¾“å…¥å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."
                            autofocus>
                        <div class="scanner-tips">
                            <p><strong>æç¤ºï¼š</strong>æ‰«ææªè¾“å…¥é€šå¸¸ä¼šä»¥å¿«é€Ÿè¾“å…¥çš„æ•°å­—åºåˆ—å½¢å¼å‡ºç°ï¼Œå¹¶è‡ªåŠ¨ä»¥å›è½¦ç»“æŸ</p>
                        </div>
                    </div>
                </div>

                <div id="status-message" class="status-message"></div>
                <div class="search-section">
                    <input type="text" id="search-input" class="search-input" placeholder="æ‰«æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...">
                </div>

                <div id="status-message" class="status-message info">
                    è¯·é€‰æ‹©æ‰«ææ–¹å¼å¹¶å¼€å§‹æ‰«æ

                    <div class="edge-fix">
                        <h3>Edgeæµè§ˆå™¨æ‘„åƒå¤´é—®é¢˜è§£å†³æ–¹æ¡ˆ</h3>
                        <ol>
                            <li>ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„é”å½¢å›¾æ ‡</li>
                            <li>ç¡®ä¿"æ‘„åƒå¤´"æƒé™è®¾ç½®ä¸º"å…è®¸"</li>
                            <li>å¦‚æœä½¿ç”¨æ‰‹æœºï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿè®¾ç½®ä¸­çš„Edgeæµè§ˆå™¨æƒé™</li>
                            <li>å°è¯•é‡å¯æµè§ˆå™¨æˆ–æ¸…é™¤ç«™ç‚¹æ•°æ®åé‡æ–°è®¿é—®</li>
                            <li>ç¡®ä¿ç½‘ç«™é€šè¿‡HTTPSè®¿é—®ï¼ˆå½“å‰çŠ¶æ€: <span id="https-status">æ£€æŸ¥ä¸­...</span>ï¼‰</li>
                        </ol>
                    </div>
        <!-- è§£ç çŠ¶æ€æç¤º -->
        <div class="decode-status" id="decode-status"></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // æ£€æŸ¥HTTPSçŠ¶æ€
            const httpsStatus = document.getElementById('https-status');
            httpsStatus.textContent = window.location.protocol === 'https:' ? 'å®‰å…¨è¿æ¥ (HTTPS)' : 'éå®‰å…¨è¿æ¥ (HTTP)';
            httpsStatus.style.color = window.location.protocol === 'https:' ? '#27ae60' : '#e74c3c';

            // ==================== æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½ ====================
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');

                    // æ›´æ–°æ ‡ç­¾é¡µæ¿€æ´»çŠ¶æ€
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));

                    tab.classList.add('active');
                    document.getElementById(tabId).classList.add('active');

                    // å¦‚æœåˆ‡æ¢åˆ°æ‰«ææ ‡ç­¾é¡µï¼Œåœæ­¢Excelç›¸å…³çš„è¯­éŸ³
                    if (tabId === 'scanner-tab') {
                        window.speechSynthesis.cancel();
                    } else if (tabId === 'excel-tab') {
                        // åœæ­¢æ‰«æå™¨
                        stopScanner();
                    }
                });
            });

            // ==================== æ‰«ææ–¹å¼é€‰æ‹©åŠŸèƒ½ ====================
            const methodBtns = document.querySelectorAll('.method-btn');
            const cameraScanArea = document.getElementById('camera-scan-area');
            const scannerInputArea = document.getElementById('scanner-input-area');
            const scannerInput = document.getElementById('scanner-input');

            // æ‰«ææ–¹å¼åˆ‡æ¢
            methodBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    methodBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // è·å–é€‰æ‹©çš„æ‰«ææ–¹å¼
                    const method = this.getAttribute('data-method');

                    // æ ¹æ®é€‰æ‹©çš„æ–¹å¼æ˜¾ç¤ºå¯¹åº”çš„æ‰«æåŒºåŸŸ
                    if (method === 'camera') {
                        cameraScanArea.style.display = 'block';
                        scannerInputArea.style.display = 'none';
                        statusMessage.textContent = 'è¯·ç‚¹å‡»"å¼€å§‹æ‰«æ"æŒ‰é’®å¯åŠ¨æ‘„åƒå¤´';
                        statusMessage.className = 'status-message info';
                    } else if (method === 'scanner') {
                        cameraScanArea.style.display = 'none';
                        scannerInputArea.style.display = 'block';
                        scannerInput.focus(); // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                        statusMessage.textContent = 'æ‰«ææªå°±ç»ªï¼Œè¯·æ‰«æå•†å“æ¡ç ';
                        statusMessage.className = 'status-message info';

                        // å¦‚æœæ‘„åƒå¤´æ­£åœ¨æ‰«æï¼Œåœæ­¢å®ƒ
                        stopScanner();
                    }
                });
            });

            // ==================== æ‰«ææªè¾“å…¥å¤„ç† ====================
            let scannerInputBuffer = '';
            let lastInputTime = 0;
            const SCAN_DELAY = 100; // æ‰«æè¾“å…¥çš„å­—ç¬¦é—´éš”é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰

            // ç›‘å¬é”®ç›˜è¾“å…¥
            document.addEventListener('keydown', function (e) {
                // åªæœ‰å½“æ‰«ææªè¾“å…¥åŒºåŸŸæ˜¾ç¤ºæ—¶æ‰å¤„ç†é”®ç›˜è¾“å…¥
                if (scannerInputArea.style.display !== 'none') {
                    const now = new Date().getTime();
                    const timeBetweenChars = now - lastInputTime;
                    lastInputTime = now;

                    // å¦‚æœå­—ç¬¦è¾“å…¥é€Ÿåº¦å¾ˆå¿«ï¼Œåˆ¤æ–­ä¸ºæ‰«ææªè¾“å…¥
                    if (e.key.length === 1 && timeBetweenChars < SCAN_DELAY) {
                        scannerInputBuffer += e.key;

                        // å½“æ£€æµ‹åˆ°å›è½¦ç¬¦æ—¶ï¼Œè®¤ä¸ºæ‰«æå®Œæˆ
                        if (e.key === 'Enter') {
                            e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„å›è½¦è¡Œä¸º

                            // å¤„ç†æ‰«æç»“æœ
                            const scanResult = scannerInputBuffer.trim();
                            if (scanResult) {
                                processScannerInput(scanResult);
                            }

                            // æ¸…ç©ºè¾“å…¥ç¼“å†²åŒº
                            scannerInputBuffer = '';
                        }
                    } else if (e.key === 'Enter' && scannerInput.value.trim()) {
                        // å¤„ç†æ‰‹åŠ¨è¾“å…¥çš„å›è½¦
                        e.preventDefault();
                        processScannerInput(scannerInput.value.trim());
                    } else {
                        // é‡ç½®ç¼“å†²åŒºï¼Œå¯èƒ½æ˜¯æ‰‹åŠ¨è¾“å…¥
                        scannerInputBuffer = '';
                    }
                }
            });

            // å¤„ç†æ‰«ææªè¾“å…¥ç»“æœ
            function processScannerInput(result) {
                // è®¾ç½®è¾“å…¥æ¡†çš„å€¼
                scannerInput.value = result;
                searchInput.value = result;
                globalFilter.value = result;

                // æ˜¾ç¤ºæ‰«æç»“æœ
                showResult(result, 'æ‰«ææª');

                // çŸ­æš‚å»¶è¿Ÿåæ¸…ç©ºè¾“å…¥æ¡†ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡æ‰«æ
                setTimeout(() => {
                    scannerInput.value = '';
                    scannerInput.focus();
                }, 1000);
            }

            // ==================== æ‰«ææ¨¡å¼é€‰æ‹©åŠŸèƒ½ ====================
            const scanModeBtns = document.querySelectorAll('.scan-mode-btn');
            let currentScanMode = 'auto'; // é»˜è®¤è‡ªåŠ¨æ¨¡å¼

            // è®¾ç½®æ‰«ææ¨¡å¼
            scanModeBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    scanModeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // æ›´æ–°æ‰«ææ¨¡å¼
                    currentScanMode = this.getAttribute('data-mode');
                    statusMessage.textContent = `å·²åˆ‡æ¢åˆ°${getModeName(currentScanMode)}æ¨¡å¼`;
                    statusMessage.className = 'status-message info';

                    // å¦‚æœæ‰«ææ­£åœ¨è¿›è¡Œï¼Œé‡æ–°å¯åŠ¨ä»¥åº”ç”¨æ–°æ¨¡å¼
                    if (scanInterval) {
                        stopScanner();
                        setTimeout(startScanner, 300);
                    }
                });
            });

            // è·å–æ¨¡å¼åç§°
            function getModeName(mode) {
                switch (mode) {
                    case 'auto': return 'è‡ªåŠ¨è¯†åˆ«';
                    case 'qr': return 'äºŒç»´ç ';
                    case 'barcode': return 'æ¡å½¢ç ';
                    default: return 'è‡ªåŠ¨è¯†åˆ«';
                }
            }

            // ==================== æ‘„åƒå¤´æ‰«æå¤„ç† ====================
            const video = document.getElementById('video');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const switchCameraBtn = document.getElementById('switch-camera');
            const searchInput = document.getElementById('search-input');
            const statusMessage = document.getElementById('status-message');
            const cameraPlaceholder = document.getElementById('camera-placeholder');
            const scanningOverlay = document.querySelector('.scanning-overlay');
            const globalFilter = document.getElementById('global-filter');
            let stream = null;
            let usingFrontCamera = false;
            let scanInterval = null;
            
            // éšè—æ‘„åƒå¤´æƒé™è¯·æ±‚UIï¼Œé»˜è®¤ç›´æ¥è·å–æƒé™
            const cameraPermissionUI = document.querySelector('.camera-permission');
            if (cameraPermissionUI) {
                cameraPermissionUI.style.display = 'none';
            }
            const permissionBtn = document.getElementById('permission-btn');
            if (permissionBtn) {
                permissionBtn.style.display = 'none';
            }

            // ä¼˜åŒ–ç”¨çš„å…¨å±€å˜é‡
            let scanningCanvas = null;
            let scanningContext = null;
            let overlayCanvas = null;
            let overlayContext = null;
            let scanLineY = 0;
            let scanLineDirection = 1;
            let scanLineAnimationInterval = null;
            let lastScannedCode = null;
            let lastScanTimestamp = 0;
            const SCAN_DEBOUNCE_MS = 1000; // é˜²æŠ–æ—¶é—´ï¼Œé¿å…é‡å¤æ‰«æ
            
            // åˆ›å»ºè¦†ç›–å±‚canvasç”¨äºç»˜åˆ¶æ‰«ææ¡†å’Œæ‰«æçº¿
            function createOverlayCanvas() {
                if (!overlayCanvas) {
                    overlayCanvas = document.createElement('canvas');
                    overlayCanvas.className = 'scanning-overlay-canvas';
                    overlayCanvas.style.position = 'absolute';
                    overlayCanvas.style.top = '0';
                    overlayCanvas.style.left = '0';
                    overlayCanvas.style.pointerEvents = 'none';
                    cameraScanArea.appendChild(overlayCanvas);
                    overlayContext = overlayCanvas.getContext('2d');
                }
            }
            
            // ç»˜åˆ¶æ‰«ææ¡†å’Œæ‰«æçº¿
            function drawScanningOverlay() {
                if (!overlayContext || !video) return;
                
                const width = video.offsetWidth;
                const height = video.offsetHeight;
                
                overlayCanvas.width = width;
                overlayCanvas.height = height;
                
                // æ¸…ç©ºç”»å¸ƒ
                overlayContext.clearRect(0, 0, width, height);
                
                // ç»˜åˆ¶åŠé€æ˜é®ç½©
                overlayContext.fillStyle = 'rgba(0, 0, 0, 0.5)';
                overlayContext.fillRect(0, 0, width, height);
                
                // è®¡ç®—æ‰«ææ¡†å¤§å°ï¼ˆå±…ä¸­ï¼Œå®½é«˜æ¯”4:3ï¼‰
                const scanBoxWidth = Math.min(width * 0.7, height * 0.7 * 4/3);
                const scanBoxHeight = scanBoxWidth * 3/4;
                const scanBoxX = (width - scanBoxWidth) / 2;
                const scanBoxY = (height - scanBoxHeight) / 2;
                
                // æ¸…é™¤æ‰«ææ¡†åŒºåŸŸçš„é®ç½©ï¼ˆåˆ›å»ºé€æ˜åŒºåŸŸï¼‰
                overlayContext.clearRect(scanBoxX, scanBoxY, scanBoxWidth, scanBoxHeight);
                
                // ç»˜åˆ¶æ‰«ææ¡†è¾¹æ¡†
                overlayContext.strokeStyle = '#00ff00';
                overlayContext.lineWidth = 2;
                overlayContext.strokeRect(scanBoxX, scanBoxY, scanBoxWidth, scanBoxHeight);
                
                // ç»˜åˆ¶æ‰«ææ¡†å››ä¸ªè§’
                const cornerLength = 20;
                const cornerWidth = 4;
                overlayContext.lineWidth = cornerWidth;
                
                // å·¦ä¸Šè§’
                overlayContext.beginPath();
                overlayContext.moveTo(scanBoxX, scanBoxY + cornerLength);
                overlayContext.lineTo(scanBoxX, scanBoxY);
                overlayContext.lineTo(scanBoxX + cornerLength, scanBoxY);
                overlayContext.stroke();
                
                // å³ä¸Šè§’
                overlayContext.beginPath();
                overlayContext.moveTo(scanBoxX + scanBoxWidth - cornerLength, scanBoxY);
                overlayContext.lineTo(scanBoxX + scanBoxWidth, scanBoxY);
                overlayContext.lineTo(scanBoxX + scanBoxWidth, scanBoxY + cornerLength);
                overlayContext.stroke();
                
                // å³ä¸‹è§’
                overlayContext.beginPath();
                overlayContext.moveTo(scanBoxX + scanBoxWidth, scanBoxY + scanBoxHeight - cornerLength);
                overlayContext.lineTo(scanBoxX + scanBoxWidth, scanBoxY + scanBoxHeight);
                overlayContext.lineTo(scanBoxX + scanBoxWidth - cornerLength, scanBoxY + scanBoxHeight);
                overlayContext.stroke();
                
                // å·¦ä¸‹è§’
                overlayContext.beginPath();
                overlayContext.moveTo(scanBoxX + cornerLength, scanBoxY + scanBoxHeight);
                overlayContext.lineTo(scanBoxX, scanBoxY + scanBoxHeight);
                overlayContext.lineTo(scanBoxX, scanBoxY + scanBoxHeight - cornerLength);
                overlayContext.stroke();
                
                // æ›´æ–°æ‰«æçº¿ä½ç½®
                scanLineY += scanLineDirection * 2;
                if (scanLineY < scanBoxY || scanLineY > scanBoxY + scanBoxHeight) {
                    scanLineDirection *= -1;
                }
                
                // ç»˜åˆ¶æ‰«æçº¿
                const gradient = overlayContext.createLinearGradient(scanBoxX, scanLineY, scanBoxX + scanBoxWidth, scanLineY);
                gradient.addColorStop(0, 'rgba(0, 255, 0, 0)');
                gradient.addColorStop(0.5, 'rgba(0, 255, 0, 0.8)');
                gradient.addColorStop(1, 'rgba(0, 255, 0, 0)');
                
                overlayContext.fillStyle = gradient;
                overlayContext.fillRect(scanBoxX, scanLineY - 1, scanBoxWidth, 3);
            }
            
            // å¯åŠ¨æ‰«æå™¨
            async function startScanner() {
                // æ¸…ç©ºä¹‹å‰çš„æ‰«æç»“æœï¼Œå…è®¸ç›´æ¥æ‰«æä¸‹ä¸€ä¸ªå•†å“
                searchInput.value = '';
                globalFilter.value = '';
                lastScannedCode = null;
                
                try {
                    statusMessage.textContent = 'æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...';
                    statusMessage.className = 'status-message info';

                    // éšè—æƒé™æŒ‡å¯¼ä¿¡æ¯
                    const edgeFix = document.querySelector('.edge-fix');
                    if (edgeFix) {
                        edgeFix.style.display = 'none';
                    }
                    
                    // ç›´æ¥è·å–æ‘„åƒå¤´åª’ä½“æµ - ç®€åŒ–é…ç½®ä»¥æé«˜å…¼å®¹æ€§
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: usingFrontCamera ? 'user' : 'environment',
                            width: { min: 640, ideal: 1280, max: 1920 },
                            height: { min: 480, ideal: 720, max: 1080 }
                        },
                        audio: false
                    });

                    // è®¾ç½®è§†é¢‘å…ƒç´ æº
                    video.srcObject = stream;

                    // æ˜¾ç¤ºè§†é¢‘å…ƒç´ ï¼Œéšè—å ä½ç¬¦
                    video.style.display = 'block';
                    cameraPlaceholder.style.display = 'none';
                    scanningOverlay.style.display = 'block';
                    
                    // åˆ›å»ºå¹¶æ˜¾ç¤ºè¦†ç›–å±‚
                    createOverlayCanvas();
                    
                    // å¼€å§‹æ‰«æçº¿åŠ¨ç”»
                    scanLineAnimationInterval = setInterval(drawScanningOverlay, 30);

                    // æ’­æ”¾è§†é¢‘
                    await video.play();

                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    startBtn.disabled = true;
                    stopBtn.disabled = false;

                    statusMessage.textContent = 'è¯·å°†å•†å“æ¡å½¢ç å¯¹å‡†æ‰«ææ¡†ï¼Œæ”¯æŒè¿œè·ç¦»å¿«é€Ÿè¯†åˆ«';
                    statusMessage.className = 'status-message success';

                    // å¼€å§‹æ‰«æ - ä¼˜åŒ–æ‰«æé—´éš”
                    scanInterval = setInterval(scanForBarcodes, 100);
                    
                    // é¢„åˆ›å»ºcanvasä»¥é¿å…é‡å¤åˆ›å»º
                    if (!scanningCanvas) {
                        scanningCanvas = document.createElement('canvas');
                        scanningContext = scanningCanvas.getContext('2d');
                    }

                } catch (error) {
                    console.error('å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:', error);
                    statusMessage.textContent = `æ— æ³•å¯åŠ¨æ‘„åƒå¤´: ${error.message}`;
                    statusMessage.className = 'status-message error';

                    // æ˜¾ç¤ºæƒé™è¯·æ±‚æŒ‰é’®
                    permissionBtn.style.display = 'block';
                    document.querySelector('.camera-permission').style.display = 'block';
                }
            }

            // åœæ­¢æ‰«æå™¨
            function stopScanner() {
                if (scanInterval) {
                    clearInterval(scanInterval);
                    scanInterval = null;
                }
                
                // åœæ­¢æ‰«æçº¿åŠ¨ç”»
                if (scanLineAnimationInterval) {
                    clearInterval(scanLineAnimationInterval);
                    scanLineAnimationInterval = null;
                }

                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }

                video.srcObject = null;
                video.style.display = 'none';
                cameraPlaceholder.style.display = 'block';
                scanningOverlay.style.display = 'none';
                
                // æ¸…é™¤è¦†ç›–å±‚å†…å®¹
                if (overlayContext) {
                    overlayContext.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                }

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                startBtn.disabled = false;
                stopBtn.disabled = true;

                statusMessage.textContent = 'æ‰«æå·²åœæ­¢';
                statusMessage.className = 'status-message info';
                
                // é‡ç½®canvaså¤§å°ä»¥é‡Šæ”¾å†…å­˜
                if (scanningCanvas) {
                    scanningCanvas.width = 1;
                    scanningCanvas.height = 1;
                }
            }

            // åˆ‡æ¢æ‘„åƒå¤´
            async function switchCamera() {
                usingFrontCamera = !usingFrontCamera;
                stopScanner();

                // çŸ­æš‚å»¶è¿Ÿåé‡æ–°å¯åŠ¨ï¼Œç¡®ä¿æ‘„åƒå¤´åˆ‡æ¢å®Œæˆ
                setTimeout(startScanner, 300);
            }

            // å›¾åƒé¢„å¤„ç†å‡½æ•° - å¢å¼ºå¯¹æ¯”åº¦å’Œé”åŒ–
            function preprocessImageData(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                // åˆ›å»ºæ–°çš„ImageDataç”¨äºå¤„ç†
                const processedData = new Uint8ClampedArray(data.length);
                
                // è‡ªé€‚åº”å¯¹æ¯”åº¦å¢å¼º
                let min = 255;
                let max = 0;
                
                // å…ˆæ‰¾åˆ°äº®åº¦çš„æœ€å°å€¼å’Œæœ€å¤§å€¼
                for (let i = 0; i < data.length; i += 4) {
                    const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    min = Math.min(min, brightness);
                    max = Math.max(max, brightness);
                }
                
                // å¢å¼ºå¯¹æ¯”åº¦
                const range = max - min || 1;
                for (let i = 0; i < data.length; i += 4) {
                    // è®¡ç®—äº®åº¦
                    let brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    
                    // åº”ç”¨å¯¹æ¯”åº¦å¢å¼º
                    brightness = ((brightness - min) / range) * 255;
                    brightness = Math.min(255, Math.max(0, brightness));
                    
                    // åˆ›å»ºäºŒå€¼åŒ–æ•ˆæœ - æé«˜æ¡ç å¯è¯»æ€§
                    const threshold = 128;
                    const binaryValue = brightness > threshold ? 255 : 0;
                    
                    processedData[i] = binaryValue;     // R
                    processedData[i + 1] = binaryValue; // G
                    processedData[i + 2] = binaryValue; // B
                    processedData[i + 3] = data[i + 3]; // A
                }
                
                return new ImageData(processedData, width, height);
            }
            
            // éªŒè¯æ¡å½¢ç æœ‰æ•ˆæ€§
            function isValidBarcode(code) {
                // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²ä¸”ä¸ä¸ºç©º
                if (typeof code !== 'string' || !code.trim()) return false;
                
                // ç§»é™¤å¯èƒ½çš„ç©ºæ ¼
                code = code.replace(/\s/g, '');
                
                // æ£€æŸ¥é•¿åº¦ - å¸¸è§æ¡ç é•¿åº¦
                const validLengths = [8, 12, 13, 14, 16, 17];
                if (!validLengths.includes(code.length)) return false;
                
                // æ£€æŸ¥æ˜¯å¦åªåŒ…å«æ•°å­—
                if (!/^\d+$/.test(code)) {
                    // å¯¹äºCode128ç­‰å¯èƒ½åŒ…å«å­—æ¯çš„æ¡ç ï¼Œå…è®¸å­—æ¯æ•°å­—
                    if (!/^[A-Z0-9]+$/i.test(code)) return false;
                }
                
                // EAN-13æ ¡éªŒ
                if (code.length === 13) {
                    let sum = 0;
                    for (let i = 0; i < 12; i++) {
                        const digit = parseInt(code[i]);
                        sum += i % 2 === 0 ? digit : digit * 3;
                    }
                    const checksum = (10 - (sum % 10)) % 10;
                    if (parseInt(code[12]) !== checksum) return false;
                }
                
                return true;
            }
            
            // æ‰«ææ¡ç  - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œç±»ä¼¼å¾®ä¿¡æ‰«ä¸€æ‰«
            function scanForBarcodes() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    // å¤ç”¨å·²åˆ›å»ºçš„canvasä»¥æé«˜æ€§èƒ½
                    scanningCanvas.width = video.videoWidth;
                    scanningCanvas.height = video.videoHeight;
                    
                    const videoWidth = video.videoWidth;
                    const videoHeight = video.videoHeight;

                    // ç»˜åˆ¶å½“å‰è§†é¢‘å¸§
                    scanningContext.drawImage(video, 0, 0, videoWidth, videoHeight);
                    
                    // è®¡ç®—æ‰«æåŒºåŸŸï¼ˆç±»ä¼¼å¾®ä¿¡çš„ä¸­å¤®æ‰«ææ¡†ï¼‰
                    const scanBoxWidth = Math.min(videoWidth * 0.8, videoHeight * 0.8 * 4/3);
                    const scanBoxHeight = scanBoxWidth * 3/4;
                    const scanBoxX = (videoWidth - scanBoxWidth) / 2;
                    const scanBoxY = (videoHeight - scanBoxHeight) / 2;
                    
                    // è·å–æ‰«æåŒºåŸŸçš„å›¾åƒæ•°æ®
                    const imageData = scanningContext.getImageData(scanBoxX, scanBoxY, scanBoxWidth, scanBoxHeight);
                    
                    // å¯¹å›¾åƒè¿›è¡Œé¢„å¤„ç†ä»¥æé«˜è¯†åˆ«ç‡
                    const processedData = preprocessImageData(imageData);
                    
                    // åœ¨canvasä¸Šç»˜åˆ¶å¤„ç†åçš„å›¾åƒï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
                    // scanningContext.putImageData(processedData, scanBoxX, scanBoxY);
                    
                    // å¤šåˆ†è¾¨ç‡æ‰«æç­–ç•¥
                    const resolutions = [
                        { scale: 1.0 },    // åŸå§‹å¤§å°
                        { scale: 0.8 },    // ç¼©å°ä¸€ç‚¹
                        { scale: 0.6 }     // ç¼©å°æ›´å¤š
                    ];
                    
                    // å°è¯•åœ¨ä¸åŒåˆ†è¾¨ç‡ä¸‹æ‰«æ
                    for (const res of resolutions) {
                        const scaledWidth = Math.floor(scanBoxWidth * res.scale);
                        const scaledHeight = Math.floor(scanBoxHeight * res.scale);
                        
                        // åˆ›å»ºä¸´æ—¶canvasç”¨äºç¼©æ”¾
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = scaledWidth;
                        tempCanvas.height = scaledHeight;
                        const tempContext = tempCanvas.getContext('2d');
                        
                        // ç¼©æ”¾å›¾åƒ
                        tempContext.putImageData(processedData, 0, 0);
                        const scaledImageData = tempContext.getImageData(0, 0, scaledWidth, scaledHeight);
                        
                        // äºŒç»´ç æ‰«æ
                        if (currentScanMode === 'qr' || currentScanMode === 'auto') {
                            const qrCode = jsQR(scaledImageData.data, scaledImageData.width, scaledImageData.height, {
                                inversionAttempts: 'attemptBoth', // å°è¯•æ­£å‘å’Œåå‘è¯†åˆ«
                                greyScaleWeights: [0.299, 0.587, 0.114] // æ ‡å‡†RGBæƒé‡
                            });

                            if (qrCode && isValidBarcode(qrCode.data)) {
                                const now = Date.now();
                                // é˜²æŠ–å¤„ç†
                                if (qrCode.data !== lastScannedCode || now - lastScanTimestamp > SCAN_DEBOUNCE_MS) {
                                    lastScannedCode = qrCode.data;
                                    lastScanTimestamp = now;
                                    
                                    // é«˜äº®æ˜¾ç¤ºæ‰¾åˆ°çš„äºŒç»´ç 
                                    if (overlayContext) {
                                        const cornerPoints = qrCode.location.cornerPoints;
                                        overlayContext.strokeStyle = '#00ff00';
                                        overlayContext.lineWidth = 3;
                                        overlayContext.beginPath();
                                        overlayContext.moveTo(cornerPoints[0].x + scanBoxX, cornerPoints[0].y + scanBoxY);
                                        for (let i = 1; i < cornerPoints.length; i++) {
                                            overlayContext.lineTo(cornerPoints[i].x + scanBoxX, cornerPoints[i].y + scanBoxY);
                                        }
                                        overlayContext.closePath();
                                        overlayContext.stroke();
                                    }
                                    
                                    searchInput.value = qrCode.data;
                                    globalFilter.value = qrCode.data;
                                    showResult(qrCode.data, 'äºŒç»´ç ');
                                    return;
                                }
                            }
                        }
                    }
                    
                    // æ¡å½¢ç æ‰«æ - ä½¿ç”¨ä¸åŒçš„æ–¹æ³•
                    if (currentScanMode === 'barcode' || currentScanMode === 'auto') {
                        try {
                            // åˆ›å»ºç”¨äºQuaggaçš„å›¾åƒæ•°æ®
                            const barcodeCanvas = document.createElement('canvas');
                            barcodeCanvas.width = scanBoxWidth;
                            barcodeCanvas.height = scanBoxHeight;
                            const barcodeContext = barcodeCanvas.getContext('2d');
                            barcodeContext.putImageData(processedData, 0, 0);
                            
                            // ä½¿ç”¨Quaggaè§£ç æ¡å½¢ç  - é«˜åº¦ä¼˜åŒ–é…ç½®
                            Quagga.decodeSingle({
                                decoder: {
                                    readers: [
                                        'code_128_reader', 
                                        'ean_reader', 
                                        'upc_reader', 
                                        'code_39_reader',
                                        'code_93_reader',
                                        'codabar_reader',
                                        'ean_8_reader'
                                    ],
                                    multiple: false,
                                    halfSample: true,  // æé«˜é€Ÿåº¦
                                    patchSize: 'medium' // å¹³è¡¡é€Ÿåº¦å’Œç²¾åº¦
                                },
                                locate: true,
                                src: barcodeCanvas.toDataURL(),
                                numOfWorkers: navigator.hardwareConcurrency || 4,
                                frequency: 15, // æ›´é«˜çš„å®šä½é¢‘ç‡
                                // å¢å¼ºé…ç½®
                                locate: {
                                    halfSample: true,
                                    patchSize: 'medium',
                                    debug: false
                                }
                            }, function (result) {
                                if (result && result.codeResult && isValidBarcode(result.codeResult.code)) {
                                    const barcode = result.codeResult.code;
                                    const now = Date.now();
                                    
                                    // é˜²æŠ–å¤„ç†
                                    if (barcode !== lastScannedCode || now - lastScanTimestamp > SCAN_DEBOUNCE_MS) {
                                        lastScannedCode = barcode;
                                        lastScanTimestamp = now;
                                        
                                        // é«˜äº®æ˜¾ç¤ºæ‰¾åˆ°çš„æ¡å½¢ç 
                                        if (overlayContext && result.box) {
                                            const box = result.box;
                                            overlayContext.strokeStyle = '#00ff00';
                                            overlayContext.lineWidth = 3;
                                            overlayContext.strokeRect(
                                                box.x + scanBoxX,
                                                box.y + scanBoxY,
                                                box.width,
                                                box.height
                                            );
                                        }
                                        
                                        searchInput.value = barcode;
                                        globalFilter.value = barcode;
                                        showResult(barcode, 'æ¡å½¢ç ');
                                    }
                                }
                            });
                        } catch (error) {
                            console.error('æ¡å½¢ç è§£ç é”™è¯¯:', error);
                        }
                    }
                }
            }

            // æ˜¾ç¤ºæ‰«æç»“æœ
            function showResult(result, type) {
                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                statusMessage.textContent = `æˆåŠŸæ‰«æ${type}: ${result}`;
                statusMessage.className = 'status-message success';

                // æ£€æŸ¥å•†å“çŠ¶æ€å¹¶æ˜¾ç¤ºæç¤º
                checkProductStatus(result);

                // 3ç§’åæ¢å¤åˆå§‹çŠ¶æ€ä½†ä¸åœæ­¢æ‰«æï¼Œå…è®¸è¿ç»­æ‰«æ
                setTimeout(() => {
                    statusMessage.textContent = 'è¯·å°†ä¸‹ä¸€ä¸ªå•†å“æ¡å½¢ç å¯¹å‡†æ‰«ææ¡†ï¼Œæ”¯æŒè¿œè·ç¦»å¿«é€Ÿè¯†åˆ«';
                    statusMessage.className = 'status-message info';
                    // æ¸…é™¤æ¡å½¢ç è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ç»§ç»­æ‰«æä¸‹ä¸€ä¸ªå•†å“
                    searchInput.value = '';
                    globalFilter.value = '';
                }, 3000);
            }

            // æ£€æŸ¥å•†å“çŠ¶æ€å¹¶æ˜¾ç¤ºæç¤º
            function checkProductStatus(scanResult) {
                if (!currentData || currentData.length === 0) {
                    statusMessage.textContent = 'è¯·å…ˆä¸Šä¼ å•†å“è¡¨æ ¼';
                    statusMessage.className = 'status-message error';
                    return;
                }

                // åœ¨å½“å‰æ•°æ®ä¸­æŸ¥æ‰¾åŒ¹é…çš„å•†å“
                const matchingProducts = currentData.filter(row => {
                    return row.some(cell => {
                        if (cell !== null && cell !== undefined) {
                            return cell.toString().includes(scanResult);
                        }
                        return false;
                    });
                });

                if (matchingProducts.length === 0) {
                    statusMessage.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„å•†å“ä¿¡æ¯';
                    statusMessage.className = 'status-message warning';
                    return;
                }
                
                // æ‰¾åˆ°åŒ¹é…å•†å“æ—¶ï¼Œä¸è®¾ç½®é”™è¯¯çš„çŠ¶æ€æ¶ˆæ¯
                statusMessage.textContent = 'å·²æ‰¾åˆ°åŒ¹é…çš„å•†å“ä¿¡æ¯';
                statusMessage.className = 'status-message success';

                // è·å–è¡¨å¤´ä¿¡æ¯ - ä»displaySheetå‡½æ•°ä¸­è·å–çš„å…¨å±€å˜é‡æˆ–è€…é‡æ–°è·å–
                let headers = [];
                if (currentWorkbook && currentSheetIndex !== undefined) {
                    const worksheet = currentWorkbook.Sheets[currentWorkbook.SheetNames[currentSheetIndex]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    if (jsonData.length > 0) {
                        headers = jsonData[0];
                    }
                }
                
                // æ£€æŸ¥å•†å“çŠ¶æ€
                const productInfo = checkSingleProductStatus(matchingProducts[0], headers);
                
                // æ˜¾ç¤ºå•†å“çŠ¶æ€æç¤º
                if (productInfo.isExpired) {
                    alert(`âš ï¸ å•†å“è¿‡æœŸè­¦å‘Š âš ï¸\n\nå•†å“åç§°: ${productInfo.productName}\nè¿‡æœŸæ—¥æœŸ: ${productInfo.expireDate}\nçŠ¶æ€: å·²è¿‡æœŸ\n\nè¯·ç«‹å³ä¸‹æ¶æ­¤å•†å“ï¼`);
                } else if (productInfo.isSoonExpired) {
                    alert(`âš ï¸ å•†å“ä¸´æœŸæé†’ âš ï¸\n\nå•†å“åç§°: ${productInfo.productName}\nè¿‡æœŸæ—¥æœŸ: ${productInfo.expireDate}\nçŠ¶æ€: å³å°†è¿‡æœŸ\nå‰©ä½™å¤©æ•°: ${productInfo.daysRemaining}å¤©\n\nè¯·åŠæ—¶å¤„ç†ï¼`);
                } else {
                    alert(`âœ… å•†å“çŠ¶æ€æ­£å¸¸ âœ…\n\nå•†å“åç§°: ${productInfo.productName}\nè¿‡æœŸæ—¥æœŸ: ${productInfo.expireDate || 'æœªè®¾ç½®'}\nçŠ¶æ€: æ­£å¸¸`);
                }
            }

            // æ£€æŸ¥å•ä¸ªå•†å“çš„çŠ¶æ€
            function checkSingleProductStatus(productRow, headers) {
                const result = {
                    productName: 'æœªçŸ¥å•†å“',
                    expireDate: null,
                    isExpired: false,
                    isSoonExpired: false,
                    daysRemaining: null
                };

                // æå–å•†å“åç§°ï¼ˆä¼˜å…ˆä½¿ç”¨ç¬¬ä¸€åˆ—æˆ–åŒ…å«åç§°å…³é”®è¯çš„åˆ—ï¼‰
                for (let i = 0; i < productRow.length && i < headers.length; i++) {
                    const header = headers[i] ? headers[i].toLowerCase() : '';
                    if (i === 0 || header.includes('åç§°') || header.includes('äº§å“') || header.includes('å•†å“')) {
                        if (productRow[i]) {
                            result.productName = productRow[i].toString();
                            break;
                        }
                    }
                }

                // æŸ¥æ‰¾æ—¥æœŸç›¸å…³çš„åˆ—
                const dateColumns = [];
                headers.forEach((header, index) => {
                    const headerLower = header ? header.toLowerCase() : '';
                    if (headerLower.includes('è¿‡æœŸ') ||
                        headerLower.includes('æœ‰æ•ˆæœŸ') ||
                        headerLower.includes('æˆªæ­¢') ||
                        headerLower.includes('åˆ°æœŸ') ||
                        headerLower.includes('expire') ||
                        headerLower.includes('æœ‰æ•ˆæœŸè‡³') ||
                        headerLower.includes('å¤±æ•ˆæ—¥æœŸ')) {
                        dateColumns.push(index);
                    }
                });

                // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                if (dateColumns.length > 0) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const thirtyDaysLater = new Date(today);
                    thirtyDaysLater.setDate(today.getDate() + 30);

                    for (const dateCol of dateColumns) {
                        if (dateCol < productRow.length && productRow[dateCol]) {
                            const expireDate = parseDateValue(productRow[dateCol]);
                            if (expireDate) {
                                result.expireDate = formatDate(expireDate);
                                
                                // è®¡ç®—å‰©ä½™å¤©æ•°
                                const timeDiff = expireDate.getTime() - today.getTime();
                                const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
                                result.daysRemaining = daysRemaining;

                                // åˆ¤æ–­çŠ¶æ€
                                if (expireDate < today) {
                                    result.isExpired = true;
                                } else if (expireDate <= thirtyDaysLater) {
                                    result.isSoonExpired = true;
                                }
                                break;
                            }
                        }
                    }
                }

                return result;
            }

            // æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYY-MM-DD
            function formatDate(date) {
                if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                    return null;
                }
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // äº‹ä»¶ç›‘å¬å™¨
            startBtn.addEventListener('click', startScanner);
            stopBtn.addEventListener('click', stopScanner);
            switchCameraBtn.addEventListener('click', switchCamera);

            // æ‘„åƒå¤´æƒé™ç°åœ¨åœ¨éœ€è¦æ—¶è‡ªåŠ¨è·å–

            // ==================== Excelè¡¨æ ¼åŠŸèƒ½ ====================
            const fileInput = document.getElementById('file-input');
            const uploadBtn = document.getElementById('upload-btn');
            const fileName = document.getElementById('file-name');
            const sheetSelect = document.getElementById('sheet-select');
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            const dropArea = document.getElementById('drop-area');
            const loading = document.getElementById('loading');
            const decodeStatus = document.getElementById('decode-status');
            const voiceSelect = document.getElementById('voice-select');
            //const globalFilter = document.getElementById('global-filter');
            const applyFilter = document.getElementById('apply-filter');
            const clearFilter = document.getElementById('clear-filter');
            const toggleColumnsBtn = document.getElementById('toggle-columns-btn');
            const columnVisibility = document.getElementById('column-visibility');
            const columnCheckboxes = document.getElementById('column-checkboxes');

            let currentWorkbook = null;
            let currentSheetIndex = 0;
            let currentData = [];
            let filteredData = [];
            let voices = [];
            let columnVisibilityState = {};
            let qrColumnIndex = -1;

            // åˆå§‹åŒ–QRç åº“
            qrcode.stringToBytes = qrcode.stringToBytesFuncs['UTF-8'];

            // åˆå§‹åŒ–è¯­éŸ³åˆæˆ
            function initSpeechSynthesis() {
                // è·å–å¯ç”¨çš„è¯­éŸ³åˆ—è¡¨
                function loadVoices() {
                    voices = speechSynthesis.getVoices();
                    voiceSelect.innerHTML = '';

                    // è¿‡æ»¤ä¸­æ–‡è¯­éŸ³
                    const chineseVoices = voices.filter(voice => voice.lang.includes('zh'));

                    if (chineseVoices.length > 0) {
                        chineseVoices.forEach(voice => {
                            const option = document.createElement('option');
                            option.value = voice.name;
                            option.textContent = `${voice.name} (${voice.lang})`;
                            voiceSelect.appendChild(option);
                        });
                    } else {
                        // å¦‚æœæ²¡æœ‰ä¸­æ–‡è¯­éŸ³ï¼Œæ˜¾ç¤ºæ‰€æœ‰å¯ç”¨è¯­éŸ³
                        voices.forEach(voice => {
                            const option = document.createElement('option');
                            option.value = voice.name;
                            option.textContent = `${voice.name} (${voice.lang})`;
                            voiceSelect.appendChild(option);
                        });
                    }
                }

                // è¯­éŸ³åŠ è½½äº‹ä»¶
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = loadVoices;
                }

                // åˆå§‹åŠ è½½
                loadVoices();
            }

            // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            uploadBtn.addEventListener('click', function () {
                fileInput.click();
            });

            // æ–‡ä»¶é€‰æ‹©å˜åŒ–äº‹ä»¶
            fileInput.addEventListener('change', function (e) {
                if (e.target.files.length) {
                    fileName.textContent = e.target.files[0].name;
                    processExcelFile(e.target.files[0]);
                }
            });

            // æ‹–æ”¾äº‹ä»¶å¤„ç†
            dropArea.addEventListener('dragover', function (e) {
                e.preventDefault();
                dropArea.style.background = '#e1f0ff';
            });

            dropArea.addEventListener('dragleave', function () {
                dropArea.style.background = '#f8fafc';
            });

            dropArea.addEventListener('drop', function (e) {
                e.preventDefault();
                dropArea.style.background = '#f8fafc';

                if (e.dataTransfer.files.length) {
                    const file = e.dataTransfer.files[0];
                    if (isExcelFile(file)) {
                        fileName.textContent = file.name;
                        processExcelFile(file);
                    } else {
                        alert('è¯·ä¸Šä¼ Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsæ ¼å¼ï¼‰');
                    }
                }
            });

            // åº”ç”¨ç­›é€‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            applyFilter.addEventListener('click', function () {
                applyGlobalFilter();
            });

            // æ¸…é™¤ç­›é€‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            clearFilter.addEventListener('click', function () {
                globalFilter.value = '';
                filteredData = [...currentData];
                renderTable(filteredData);
            });

            // æ˜¾ç¤º/éšè—åˆ—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            toggleColumnsBtn.addEventListener('click', function () {
                columnVisibility.style.display = columnVisibility.style.display === 'none' ? 'block' : 'none';
            });

            // æ£€æŸ¥æ˜¯å¦ä¸ºExcelæ–‡ä»¶
            function isExcelFile(file) {
                return file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                    file.type === 'application/vnd.ms-excel' ||
                    file.name.endsWith('.xlsx') ||
                    file.name.endsWith('.xls');
            }

            // å¤„ç†Excelæ–‡ä»¶
            function processExcelFile(file) {
                loading.style.display = 'block';

                const reader = new FileReader();

                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        currentWorkbook = XLSX.read(data, { type: 'array' });

                        // æ¸…ç©ºå·¥ä½œè¡¨é€‰æ‹©ä¸‹æ‹‰èœå•
                        sheetSelect.innerHTML = '';

                        // å¡«å……å·¥ä½œè¡¨é€‰æ‹©ä¸‹æ‹‰èœå•
                        currentWorkbook.SheetNames.forEach((sheetName, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = sheetName;
                            sheetSelect.appendChild(option);
                        });

                        // æ˜¾ç¤ºç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                        displaySheet(currentWorkbook, 0);

                        // å·¥ä½œè¡¨é€‰æ‹©å˜åŒ–äº‹ä»¶
                        sheetSelect.addEventListener('change', function () {
                            currentSheetIndex = parseInt(this.value);
                            displaySheet(currentWorkbook, currentSheetIndex);
                        });

                        loading.style.display = 'none';
                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        alert('å¤„ç†Excelæ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
                        loading.style.display = 'none';
                    }
                };

                reader.onerror = function () {
                    alert('è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯');
                    loading.style.display = 'none';
                };

                reader.readAsArrayBuffer(file);
            }

            // ç”Ÿæˆæ¡å½¢ç 
            function generateBarcode(text, cellElement) {
                try {
                    const typeNumber = 0; // è‡ªåŠ¨æ£€æµ‹
                    const errorCorrectionLevel = 'L';
                    const qr = qrcode(typeNumber, errorCorrectionLevel);
                    qr.addData(text);
                    qr.make();

                    const qrElement = document.createElement('div');
                    qrElement.className = 'barcode';
                    qrElement.innerHTML = qr.createSvgTag({
                        scalable: true,
                        margin: 0,
                        color: {
                            dark: "#000000",
                            light: "#ffffff"
                        }
                    });

                    // è®¾ç½®SVGå¤§å°
                    const svg = qrElement.querySelector('svg');
                    svg.setAttribute('width', '80');
                    svg.setAttribute('height', '80');

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                    qrElement.addEventListener('click', function () {
                        decodeAndSpeakBarcode(text, qrElement);
                    });

                    cellElement.appendChild(qrElement);
                } catch (error) {
                    console.error('ç”Ÿæˆæ¡å½¢ç æ—¶å‡ºé”™:', error);
                    cellElement.innerHTML = '<div class="barcode">æ¡ç ç”Ÿæˆå¤±è´¥</div>';
                }
            }

            // è§£ç å¹¶æœ—è¯»æ¡å½¢ç å†…å®¹
            function decodeAndSpeakBarcode(content, element) {
                // æ˜¾ç¤ºè§£ç ä¸­çŠ¶æ€
                showDecodeStatus('è§£ç ä¸­...', '');

                // æ¨¡æ‹Ÿè§£ç è¿‡ç¨‹ï¼ˆå®é™…ä¸Šæˆ‘ä»¬å·²ç»æœ‰å†…å®¹ï¼Œä¸éœ€è¦çœŸæ­£è§£ç å›¾åƒï¼‰
                setTimeout(() => {
                    try {
                        // æ˜¾ç¤ºè§£ç æˆåŠŸçŠ¶æ€
                        showDecodeStatus('è§£ç æˆåŠŸ', 'success');

                        // æœ—è¯»å†…å®¹
                        speakText(content);

                        // æ·»åŠ è§†è§‰åé¦ˆ
                        element.style.boxShadow = '0 0 0 3px #27ae60';
                        setTimeout(() => {
                            element.style.boxShadow = '';
                        }, 1000);
                    } catch (error) {
                        console.error('è§£ç æˆ–æœ—è¯»å‡ºé”™:', error);
                        showDecodeStatus('è§£ç å¤±è´¥: ' + error.message, 'error');
                    }
                }, 300);
            }

            // æ˜¾ç¤ºè§£ç çŠ¶æ€
            function showDecodeStatus(message, type) {
                decodeStatus.textContent = message;
                decodeStatus.className = 'decode-status';

                if (type) {
                    decodeStatus.classList.add(type);
                }

                decodeStatus.classList.add('show');

                // 3ç§’åéšè—çŠ¶æ€
                setTimeout(() => {
                    decodeStatus.classList.remove('show');
                }, 3000);
            }

            // è¯­éŸ³æœ—è¯»åŠŸèƒ½
            function speakText(text) {
                if ('speechSynthesis' in window) {
                    // åœæ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„è¯­éŸ³
                    window.speechSynthesis.cancel();

                    // åˆ›å»ºè¯­éŸ³å®ä¾‹
                    const utterance = new SpeechSynthesisUtterance(text);

                    // è®¾ç½®è¯­è¨€
                    utterance.lang = 'zh-CN';

                    // è®¾ç½®è¯­é€Ÿ
                    utterance.rate = 0.9;

                    // è®¾ç½®éŸ³è°ƒ
                    utterance.pitch = 1.0;

                    // è®¾ç½®éŸ³é‡
                    utterance.volume = 1.0;

                    // å¦‚æœé€‰æ‹©äº†ç‰¹å®šè¯­éŸ³ï¼Œä½¿ç”¨è¯¥è¯­éŸ³
                    if (voiceSelect.value) {
                        const selectedVoice = voices.find(voice => voice.name === voiceSelect.value);
                        if (selectedVoice) {
                            utterance.voice = selectedVoice;
                        }
                    }

                    // æœ—è¯»æ–‡æœ¬
                    window.speechSynthesis.speak(utterance);
                } else {
                    showDecodeStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½', 'error');
                }
            }

            // æ£€æŸ¥å•†å“æ˜¯å¦è¿‡æœŸ
            function checkExpiredProducts(data, headers) {
                console.log('å¼€å§‹æ£€æŸ¥è¿‡æœŸå•†å“');
                console.log('è¡¨å¤´ä¿¡æ¯:', headers);

                // æŸ¥æ‰¾æ—¥æœŸç›¸å…³çš„åˆ— - å¢å¼ºå…³é”®è¯åŒ¹é…
                const dateColumns = [];
                headers.forEach((header, index) => {
                    const headerLower = header ? header.toLowerCase() : '';
                    if (headerLower.includes('è¿‡æœŸ') ||
                        headerLower.includes('æœ‰æ•ˆæœŸ') ||
                        headerLower.includes('æˆªæ­¢') ||
                        headerLower.includes('åˆ°æœŸ') ||
                        headerLower.includes('expire') ||
                        headerLower.includes('æœ‰æ•ˆæœŸè‡³') ||
                        headerLower.includes('å¤±æ•ˆæ—¥æœŸ') ||
                        headerLower.includes('use by') ||
                        headerLower.includes('best before')) {
                        dateColumns.push(index);
                        console.log(`æ‰¾åˆ°æ—¥æœŸåˆ—: ${header} (ç´¢å¼•: ${index})`);
                    }
                });

                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ—¥æœŸåˆ—ï¼Œå°è¯•æ‰€æœ‰åˆ—è¿›è¡Œæ—¥æœŸæ£€æµ‹
                if (dateColumns.length === 0) {
                    console.log('æœªæ‰¾åˆ°æ˜æ˜¾çš„æ—¥æœŸåˆ—ï¼Œå°è¯•æ£€æµ‹æ‰€æœ‰åˆ—ä¸­çš„æ—¥æœŸæ ¼å¼');
                    // å…ˆæ£€æŸ¥ä¸€éƒ¨åˆ†æ•°æ®è¡Œæ¥è¯†åˆ«å¯èƒ½çš„æ—¥æœŸåˆ—
                    const sampleRows = data.slice(0, Math.min(10, data.length)); // æ£€æŸ¥å‰10è¡Œ

                    sampleRows.forEach(row => {
                        row.forEach((cell, index) => {
                            if (!dateColumns.includes(index) && isDateValue(cell)) {
                                dateColumns.push(index);
                                console.log(`è‡ªåŠ¨æ£€æµ‹åˆ°æ—¥æœŸåˆ— (ç´¢å¼•: ${index})`);
                            }
                        });
                    });
                }

                if (dateColumns.length === 0) {
                    console.log('æœªæ£€æµ‹åˆ°ä»»ä½•æ—¥æœŸåˆ—');
                    return { expiredCount: 0, soonExpiredCount: 0, expiredProducts: [] };
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                console.log('å½“å‰æ—¥æœŸ:', today.toISOString().split('T')[0]);

                // è®¡ç®—30å¤©åçš„æ—¥æœŸï¼Œç”¨äºåˆ¤æ–­å³å°†è¿‡æœŸ
                const thirtyDaysLater = new Date(today);
                thirtyDaysLater.setDate(today.getDate() + 30);
                console.log('30å¤©åæ—¥æœŸ:', thirtyDaysLater.toISOString().split('T')[0]);

                // ä½¿ç”¨è®¡æ•°å™¨æ›¿ä»£Setï¼Œé¿å…å› å•†å“æ ‡è¯†é—®é¢˜å¯¼è‡´çš„è®¡æ•°é”™è¯¯
                let expiredCount = 0;
                let soonExpiredCount = 0;
                let totalChecked = 0;
                
                // æ–°å¢ï¼šæ”¶é›†è¿‡æœŸå•†å“å’Œä¸´æœŸå•†å“çš„è¯¦ç»†ä¿¡æ¯
                const expiredProducts = [];
                const soonExpiredProducts = [];

                data.forEach((row, rowIndex) => {
                    // è·³è¿‡ç©ºè¡Œ
                    if (!row || row.length === 0 || !row.some(cell => cell !== null && cell !== undefined && cell !== '')) {
                        return;
                    }

                    totalChecked++;
                    let isExpired = false;
                    let isSoonExpired = false;
                    let productDate = null;

                    dateColumns.forEach(colIndex => {
                        const cellValue = row[colIndex];
                        let expireDate = parseDateValue(cellValue);

                        if (expireDate) {
                            // è®°å½•æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ—¥æœŸ
                            if (!productDate) {
                                productDate = expireDate;
                            }

                            // åˆ¤æ–­æ˜¯å¦è¿‡æœŸ
                            if (expireDate < today) {
                                isExpired = true;
                            } else if (expireDate <= thirtyDaysLater) {
                                isSoonExpired = true;
                            }
                        }
                    });

                    // æ™ºèƒ½æå–å•†å“åç§° - å°è¯•å¤šä¸ªå¯èƒ½çš„åˆ—
                    let productName = 'æœªå‘½åå•†å“';
                    // é¦–å…ˆå°è¯•ç¬¬ä¸€åˆ—
                    if (row[0] && row[0].toString().trim()) {
                        productName = row[0].toString().trim();
                    } else {
                        // å¦‚æœç¬¬ä¸€åˆ—ä¸ºç©ºï¼Œå°è¯•æŸ¥æ‰¾åŒ…å«"åç§°"ã€"å•†å“"ç­‰å…³é”®è¯çš„åˆ—
                        headers.forEach((header, index) => {
                            const headerLower = header ? header.toLowerCase() : '';
                            if ((headerLower.includes('åç§°') || 
                                 headerLower.includes('å•†å“') || 
                                 headerLower.includes('product') || 
                                 headerLower.includes('name')) && 
                                row[index] && row[index].toString().trim()) {
                                productName = row[index].toString().trim();
                            }
                        });
                    }

                    if (isExpired) {
                        expiredCount++;
                        const expireDateStr = productDate ? productDate.toISOString().split('T')[0] : 'æœªçŸ¥';
                        console.log(`æ‰¾åˆ°è¿‡æœŸå•†å“ (è¡Œ${rowIndex + 2}): ${productName}, è¿‡æœŸæ—¥æœŸ: ${expireDateStr}`);
                        
                        // æ–°å¢ï¼šè®°å½•è¿‡æœŸå•†å“è¯¦ç»†ä¿¡æ¯
                        expiredProducts.push({
                            name: productName,
                            expireDate: expireDateStr,
                            row: rowIndex + 2 // è¡Œå·ï¼ˆ+2æ˜¯å› ä¸ºæ•°æ®ä»ç¬¬2è¡Œå¼€å§‹ï¼Œä¸”æ•°ç»„ç´¢å¼•ä»0å¼€å§‹ï¼‰
                        });
                    } else if (isSoonExpired) {
                        soonExpiredCount++;
                        const expireDateStr = productDate ? productDate.toISOString().split('T')[0] : 'æœªçŸ¥';
                        // è®¡ç®—å‰©ä½™å¤©æ•°
                        const daysRemaining = Math.ceil((productDate - today) / (1000 * 60 * 60 * 24));
                        console.log(`æ‰¾åˆ°å³å°†è¿‡æœŸå•†å“ (è¡Œ${rowIndex + 2}): ${productName}, è¿‡æœŸæ—¥æœŸ: ${expireDateStr}, å‰©ä½™${daysRemaining}å¤©`);
                        
                        // æ–°å¢ï¼šè®°å½•ä¸´æœŸå•†å“è¯¦ç»†ä¿¡æ¯
                        soonExpiredProducts.push({
                            name: productName,
                            expireDate: expireDateStr,
                            row: rowIndex + 2,
                            daysRemaining: daysRemaining
                        });
                    }
                });

                console.log(`å•†å“æ£€æŸ¥ç»“æœ: å…±æ£€æŸ¥${totalChecked}ä¸ªå•†å“, ${expiredCount}ä¸ªå·²è¿‡æœŸ, ${soonExpiredCount}ä¸ªå³å°†è¿‡æœŸ`);
                console.log('è¿‡æœŸå•†å“è¯¦æƒ…:', expiredProducts);
                console.log('ä¸´æœŸå•†å“è¯¦æƒ…:', soonExpiredProducts);

                return {
                    expiredCount: expiredCount,
                    soonExpiredCount: soonExpiredCount,
                    expiredProducts: expiredProducts,
                    soonExpiredProducts: soonExpiredProducts // æ–°å¢ï¼šè¿”å›ä¸´æœŸå•†å“åˆ—è¡¨
                };
            }

            // åˆ¤æ–­æ˜¯å¦ä¸ºæ—¥æœŸå€¼
            function isDateValue(value) {
                if (value === null || value === undefined || value === '') return false;

                // Excelæ•°å­—æ—¥æœŸæ ¼å¼åˆ¤æ–­
                if (typeof value === 'number' && value > 25569) {
                    return true;
                }

                // å­—ç¬¦ä¸²æ—¥æœŸæ ¼å¼åˆ¤æ–­
                if (typeof value === 'string') {
                    // å¸¸è§æ—¥æœŸæ ¼å¼æ­£åˆ™
                    const dateRegexes = [
                        /^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/, // YYYY-MM-DD or YYYY/MM/DD
                        /^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}$/, // DD-MM-YYYY or DD/MM/YYYY
                        /^\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥$/,        // YYYYå¹´MMæœˆDDæ—¥
                        /^\d{2}\.\d{2}\.\d{4}$/,            // DD.MM.YYYY
                        /^\d{4}\.\d{2}\.\d{2}$/             // YYYY.MM.DD
                    ];

                    for (const regex of dateRegexes) {
                        if (regex.test(value.trim())) {
                            return true;
                        }
                    }
                }

                return false;
            }

            // è§£æå„ç§æ—¥æœŸæ ¼å¼
            function parseDateValue(value) {
                if (value === null || value === undefined || value === '') return null;

                let date;

                // å¤„ç†Excelæ•°å­—æ—¥æœŸæ ¼å¼
                if (typeof value === 'number' && value > 25569) {
                    // æ³¨æ„ï¼šExcelçš„æ—¥æœŸä»1900-01-01å¼€å§‹ï¼Œä½†å®ƒé”™è¯¯åœ°è®¤ä¸º1900å¹´æ˜¯é—°å¹´
                    // å› æ­¤éœ€è¦å¤„ç†è¿™ä¸ªå·®å¼‚
                    const excelDate = value < 60 ? value : value + 1; // å¤„ç†1900å¹´é—°å¹´é—®é¢˜
                    date = new Date((excelDate - 25569) * 86400000);
                }
                // å¤„ç†å­—ç¬¦ä¸²æ—¥æœŸ
                else if (typeof value === 'string') {
                    const trimmedValue = value.trim();

                    // å°è¯•ç›´æ¥è§£æ
                    date = new Date(trimmedValue);

                    // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
                    if (isNaN(date.getTime())) {
                        // å°è¯•å¤„ç†ä¸­æ–‡æ—¥æœŸæ ¼å¼ YYYYå¹´MMæœˆDDæ—¥
                        if (trimmedValue.includes('å¹´') && trimmedValue.includes('æœˆ') && trimmedValue.includes('æ—¥')) {
                            const year = parseInt(trimmedValue.match(/(\d{4})å¹´/)[1]);
                            const month = parseInt(trimmedValue.match(/(\d{1,2})æœˆ/)[1]) - 1;
                            const day = parseInt(trimmedValue.match(/(\d{1,2})æ—¥/)[1]);
                            date = new Date(year, month, day);
                        }
                        // å°è¯•å¤„ç†å…¶ä»–åˆ†éš”ç¬¦æ ¼å¼
                        else {
                            // æ›¿æ¢å„ç§åˆ†éš”ç¬¦ä¸º'/'ä»¥ä¾¿ç»Ÿä¸€è§£æ
                            const normalizedDate = trimmedValue.replace(/[\-\.\/]/g, '/');
                            date = new Date(normalizedDate);
                        }
                    }
                }

                // éªŒè¯æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (date && !isNaN(date.getTime())) {
                    // æ ‡å‡†åŒ–æ—¥æœŸï¼ˆæ¸…é™¤æ—¶é—´éƒ¨åˆ†ï¼‰
                    date.setHours(0, 0, 0, 0);
                    return date;
                }

                return null;
            }

            // æ˜¾ç¤ºè¿‡æœŸå•†å“å’Œä¸´æœŸå•†å“æç¤ºå¼¹çª—
            function showExpirationAlert(expiredCount, soonExpiredCount, expiredProducts, soonExpiredProducts) {
                // å…ˆæ˜¾ç¤ºæ€»ä½“ç»Ÿè®¡ä¿¡æ¯
                if (expiredCount === 0 && soonExpiredCount === 0) {
                    alert('æ‰€æœ‰å•†å“å‡åœ¨æœ‰æ•ˆæœŸå†…ï¼');
                } else {
                    let message = 'Excelå¯¼å…¥å®Œæˆï¼\n';
                    if (expiredCount > 0) {
                        message += `æœ‰ ${expiredCount} ç§å•†å“å·²è¿‡æœŸï¼\n`;
                    }
                    if (soonExpiredCount > 0) {
                        message += `æœ‰ ${soonExpiredCount} ç§å•†å“å³å°†åœ¨30å¤©å†…è¿‡æœŸï¼`;
                    }
                    alert(message);
                }
                
                // é’ˆå¯¹ä¸´æœŸå•†å“æ˜¾ç¤ºæç¤º
                if (soonExpiredProducts && soonExpiredProducts.length > 0) {
                    console.log('å¼€å§‹æ˜¾ç¤ºä¸´æœŸå•†å“æç¤º');
                    
                    // é€ä¸€æ˜¾ç¤ºä¸´æœŸå•†å“
                    soonExpiredProducts.forEach((product, index) => {
                        // å»¶è¿Ÿæ˜¾ç¤ºï¼Œé¿å…å¼¹çª—è¿ç»­å¼¹å‡ºå¯¼è‡´ç”¨æˆ·ä½“éªŒé—®é¢˜
                        setTimeout(() => {
                            alert(`âš ï¸ å•†å“ä¸´æœŸæé†’ âš ï¸\n\nå•†å“åç§°: ${product.name}\nè¿‡æœŸæ—¥æœŸ: ${product.expireDate}\næ‰€åœ¨è¡Œ: ${product.row}\nå‰©ä½™å¤©æ•°: ${product.daysRemaining}å¤©\n\nè¯·åŠæ—¶å¤„ç†ï¼`);
                        }, index * 100 + 500); // ä¸´æœŸå•†å“æç¤ºåœ¨è¿‡æœŸå•†å“æç¤ºä¹‹åæ˜¾ç¤º
                    });
                }
                
                // ç„¶åé’ˆå¯¹æ¯ä¸ªè¿‡æœŸå•†å“æ˜¾ç¤ºç«‹å³ä¸‹æ¶æç¤º
                if (expiredProducts && expiredProducts.length > 0) {
                    console.log('å¼€å§‹æ˜¾ç¤ºè¿‡æœŸå•†å“ä¸‹æ¶æç¤º');
                    
                    // é€ä¸€æ˜¾ç¤ºè¿‡æœŸå•†å“
                    expiredProducts.forEach((product, index) => {
                        // å»¶è¿Ÿæ˜¾ç¤ºï¼Œé¿å…å¼¹çª—è¿ç»­å¼¹å‡ºå¯¼è‡´ç”¨æˆ·ä½“éªŒé—®é¢˜
                        setTimeout(() => {
                            alert(`âš ï¸ å•†å“è¿‡æœŸè­¦å‘Š âš ï¸\n\nå•†å“åç§°: ${product.name}\nè¿‡æœŸæ—¥æœŸ: ${product.expireDate}\næ‰€åœ¨è¡Œ: ${product.row}\n\nè¯·ç«‹å³ä¸‹æ¶æ­¤å•†å“ï¼`);
                        }, index * 100); // æ¯ä¸ªå¼¹çª—é—´éš”100æ¯«ç§’
                    });
                }
            }

            // æ˜¾ç¤ºå·¥ä½œè¡¨å†…å®¹
            function displaySheet(workbook, sheetIndex) {
                const worksheet = workbook.Sheets[workbook.SheetNames[sheetIndex]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // æ¸…ç©ºè¡¨æ ¼
                tableHeader.innerHTML = '';
                tableBody.innerHTML = '';
                columnCheckboxes.innerHTML = '';
                columnVisibilityState = {};

                if (jsonData.length <= 1) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 13;
                    td.textContent = 'æ²¡æœ‰æ‰¾åˆ°æ•°æ®æˆ–å·¥ä½œè¡¨ä¸ºç©º';
                    td.style.textAlign = 'center';
                    td.style.padding = '20px';
                    td.style.color = '#7f8c8d';
                    tr.appendChild(td);
                    // æ£€æŸ¥æ˜¯å¦ä¸ºè¿‡æœŸå•†å“è¡Œï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ çº¢è‰²æ ·å¼
                    if (expiredRows.includes(i)) {
                        tr.style.color = 'red';
                        tr.style.fontWeight = 'bold';
                    } 
                    // æ£€æŸ¥æ˜¯å¦ä¸ºä¸´æœŸå•†å“è¡Œï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ æ©™è‰²æ ·å¼å’Œå‰©ä½™å¤©æ•°æç¤º
                    else {
                        const soonExpiredItem = soonExpiredRows.find(item => item.row === i);
                        if (soonExpiredItem) {
                            tr.style.color = 'orange';
                            
                            // æ·»åŠ ä¸€ä¸ªå‰©ä½™å¤©æ•°æç¤ºçš„å•å…ƒæ ¼
                            const daysCell = document.createElement('td');
                            daysCell.textContent = `å‰©ä½™${soonExpiredItem.days}å¤©`;
                            daysCell.style.fontWeight = 'bold';
                            daysCell.style.backgroundColor = '#fff3cd';
                            daysCell.style.padding = '5px 10px';
                            daysCell.style.borderRadius = '4px';
                            tr.appendChild(daysCell);
                        }
                    }
                    
                    tableBody.appendChild(tr);
                    return;
                }

                // è·å–è¡¨å¤´
                const headers = jsonData[0];

                // æŸ¥æ‰¾QRåˆ—å‡†å¤‡çš„ç´¢å¼•
                qrColumnIndex = headers.findIndex(header => header === 'QRåˆ—å‡†å¤‡');

                // åˆ›å»ºè¡¨å¤´è¡Œ
                const headerRow = document.createElement('tr');

                headers.forEach((header, index) => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    th.setAttribute('data-column', index);

                    // æ·»åŠ æ’åºå›¾æ ‡
                    const sortIcon = document.createElement('span');
                    sortIcon.className = 'sort-icon';
                    sortIcon.textContent = 'â†•';
                    th.appendChild(sortIcon);

                    // æ·»åŠ åˆ—æ˜¾ç¤º/éšè—åˆ‡æ¢
                    const toggleBtn = document.createElement('span');
                    toggleBtn.className = 'column-toggle';
                    toggleBtn.textContent = 'âŠ™';
                    toggleBtn.title = 'ç‚¹å‡»æ˜¾ç¤º/éšè—æ­¤åˆ—';
                    toggleBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        toggleColumnVisibility(index);
                    });
                    th.appendChild(toggleBtn);

                    // æ·»åŠ æ’åºåŠŸèƒ½
                    th.addEventListener('click', function () {
                        sortTable(index);
                    });

                    headerRow.appendChild(th);

                    // åˆå§‹åŒ–åˆ—å¯è§æ€§çŠ¶æ€
                    columnVisibilityState[index] = true;

                    // æ·»åŠ åˆ—æ˜¾ç¤ºå¤é€‰æ¡†
                    const checkbox = document.createElement('div');
                    checkbox.className = 'column-checkbox';

                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = `col-${index}`;
                    input.checked = true;
                    input.addEventListener('change', function () {
                        toggleColumnVisibility(index);
                    });

                    const label = document.createElement('label');
                    label.htmlFor = `col-${index}`;
                    label.textContent = header;

                    checkbox.appendChild(input);
                    checkbox.appendChild(label);
                    columnCheckboxes.appendChild(checkbox);
                });

                // æ·»åŠ æ¡å½¢ç åˆ—çš„è¡¨å¤´
                if (qrColumnIndex !== -1) {
                    const qrTh = document.createElement('th');
                    qrTh.textContent = 'æ¡å½¢ç ';
                    headerRow.appendChild(qrTh);
                }

                tableHeader.appendChild(headerRow);

                // æå–æ•°æ®
                currentData = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row && row.length > 0) {
                        currentData.push(row);
                    }
                }

                filteredData = [...currentData];

                // æ£€æŸ¥è¿‡æœŸå•†å“å¹¶æ˜¾ç¤ºæç¤º
                let expiredRows = [];
                let soonExpiredRows = [];
                if (currentData.length > 0) {
                    const { expiredCount, soonExpiredCount, expiredProducts, soonExpiredProducts } = checkExpiredProducts(currentData, headers);
                    // å­˜å‚¨è¿‡æœŸå•†å“å’Œä¸´æœŸå•†å“çš„è¡Œå·ï¼ˆæ³¨æ„ï¼šè¿™é‡Œçš„è¡Œå·æ˜¯ç›¸å¯¹äºcurrentDataçš„ç´¢å¼•ï¼‰
                    expiredRows = expiredProducts.map(p => p.row - 2); // å‡å»2æ˜¯å› ä¸ºproduct.rowåŒ…å«äº†è¡¨å¤´çš„åç§»
                    soonExpiredRows = soonExpiredProducts.map(p => ({ row: p.row - 2, days: p.daysRemaining }));
                    
                    // ä½¿ç”¨setTimeoutç¡®ä¿è¡¨æ ¼æ¸²æŸ“å®Œæˆåå†æ˜¾ç¤ºå¼¹çª—
                    setTimeout(() => {
                        showExpirationAlert(expiredCount, soonExpiredCount, expiredProducts, soonExpiredProducts);
                    }, 100);
                }
                
                // æ¸²æŸ“è¡¨æ ¼ï¼Œå¹¶ä¼ é€’è¿‡æœŸå•†å“å’Œä¸´æœŸå•†å“è¡Œä¿¡æ¯
                renderTable(filteredData, expiredRows, soonExpiredRows);
            }

            // å­˜å‚¨è¿‡æœŸå•†å“å’Œä¸´æœŸå•†å“è¡Œä¿¡æ¯çš„å…¨å±€å˜é‡
            let expiredRows = [];
            let soonExpiredRows = [];
            
            // æ¸²æŸ“è¡¨æ ¼æ•°æ®
            function renderTable(data, expiredRowsData = [], soonExpiredRowsData = []) {
                // æ›´æ–°è¿‡æœŸå•†å“å’Œä¸´æœŸå•†å“è¡Œä¿¡æ¯
                expiredRows = expiredRowsData;
                soonExpiredRows = soonExpiredRowsData;
                tableBody.innerHTML = '';

                if (data.length === 0) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = tableHeader.rows[0].cells.length;
                    td.textContent = 'æ²¡æœ‰åŒ¹é…çš„æ•°æ®';
                    td.style.textAlign = 'center';
                    td.style.padding = '20px';
                    td.style.color = '#7f8c8d';
                    tr.appendChild(td);
                    tableBody.appendChild(tr);
                    return;
                }

                data.forEach(row => {
                    const tr = document.createElement('tr');

                    // åˆ›å»ºæ•°æ®å•å…ƒæ ¼
                    row.forEach((cell, index) => {
                        if (columnVisibilityState[index] !== false) {
                            const td = document.createElement('td');

                            // æ£€æµ‹å¹¶è½¬æ¢Excelæ—¥æœŸæ ¼å¼ï¼ˆæ•°å­—è½¬æ¢ä¸ºYYYY=MM-DDï¼‰
                            let displayValue = cell;
                            if (typeof cell === 'number' && cell > 25569 && cell < 50000) {
                                try {
                                    // Excelæ—¥æœŸä»1900-01-01å¼€å§‹ï¼ŒJavaScriptä»1970-01-01å¼€å§‹
                                    // è°ƒæ•´Excelæ—¥æœŸï¼ˆæ³¨æ„ï¼šExcelé”™è¯¯åœ°è®¤ä¸º1900å¹´æ˜¯é—°å¹´ï¼‰
                                    const date = new Date((cell - 25569) * 86400000);
                                    const year = String(date.getFullYear()); // è·å–å®Œæ•´å¹´ä»½
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    displayValue = `${year}-${month}-${day}`;
                                } catch (e) {
                                    // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œä¿ç•™åŸå§‹å€¼
                                }
                            }

                            td.textContent = displayValue;
                            tr.appendChild(td);
                        }
                    });

                    // æ·»åŠ æ¡å½¢ç å•å…ƒæ ¼
                    if (qrColumnIndex !== -1 && row[qrColumnIndex]) {
                        const qrTd = document.createElement('td');
                        qrTd.className = 'barcode-cell';

                        // ç”Ÿæˆæ¡å½¢ç 
                        generateBarcode(row[qrColumnIndex], qrTd);
                        tr.appendChild(qrTd);
                    }

                    tableBody.appendChild(tr);
                });

                // æ›´æ–°éšè—åˆ—çš„æ˜¾ç¤ºçŠ¶æ€
                updateColumnVisibility();
            }

            // åˆ‡æ¢åˆ—å¯è§æ€§
            function toggleColumnVisibility(columnIndex) {
                columnVisibilityState[columnIndex] = !columnVisibilityState[columnIndex];

                // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                const checkbox = document.getElementById(`col-${columnIndex}`);
                if (checkbox) {
                    checkbox.checked = columnVisibilityState[columnIndex];
                }

                // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
                updateColumnVisibility();
            }

            // æ›´æ–°åˆ—å¯è§æ€§
            function updateColumnVisibility() {
                // æ›´æ–°è¡¨å¤´
                const headerCells = tableHeader.rows[0].cells;
                for (let i = 0; i < headerCells.length; i++) {
                    const columnIndex = headerCells[i].getAttribute('data-column');
                    if (columnIndex !== null) {
                        if (columnVisibilityState[columnIndex] === false) {
                            headerCells[i].classList.add('hidden-column');
                        } else {
                            headerCells[i].classList.remove('hidden-column');
                        }
                    }
                }

                // æ›´æ–°æ•°æ®è¡Œ
                const dataRows = tableBody.rows;
                for (let i = 0; i < dataRows.length; i++) {
                    const cells = dataRows[i].cells;
                    for (let j = 0; j < cells.length; j++) {
                        const columnIndex = j;
                        if (columnVisibilityState[columnIndex] === false) {
                            cells[j].classList.add('hidden-column');
                        } else {
                            cells[j].classList.remove('hidden-column');
                        }
                    }
                }
            }

            // è¡¨æ ¼æ’åº
            function sortTable(columnIndex) {
                filteredData.sort((a, b) => {
                    const valA = a[columnIndex] || '';
                    const valB = b[columnIndex] || '';

                    if (typeof valA === 'string' && typeof valB === 'string') {
                        return valA.localeCompare(valB, 'zh-CN');
                    }

                    return valA - valB;
                });

                renderTable(filteredData);
            }

            // åº”ç”¨å…¨å±€ç­›é€‰
            function applyGlobalFilter() {
                const filterText = globalFilter.value.toLowerCase();

                if (!filterText) {
                    filteredData = [...currentData];
                    renderTable(filteredData);
                    return;
                }

                filteredData = currentData.filter(row => {
                    return row.some(cell => {
                        if (cell !== null && cell !== undefined) {
                            return cell.toString().toLowerCase().includes(filterText);
                        }
                        return false;
                    });
                });

                renderTable(filteredData);
            }

            // åˆå§‹åŒ–è¯­éŸ³
            initSpeechSynthesis();
        });

        // ç™»å½•éªŒè¯å‡½æ•°
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');

            // å¤„ç†è¾“å…¥ï¼Œå»é™¤é¦–å°¾ç©ºæ ¼ - è§£å†³ç§»åŠ¨è®¾å¤‡ä¸Šå¯èƒ½å‡ºç°çš„ç©ºæ ¼é—®é¢˜
            const trimmedUsername = username.trim();
            const trimmedPassword = password.trim();

            // éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
            if (trimmedUsername === 'xjxs' && trimmedPassword === 'XJXS1234') {
                // ç™»å½•æˆåŠŸ
                document.getElementById('login-screen').style.display = 'none';
                document.querySelector('.main-content').style.display = 'block';
                errorMsg.textContent = '';
            } else {
                // ç™»å½•å¤±è´¥
                errorMsg.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
            }
        }

        // æ·»åŠ ç™»å½•è¡¨å•çš„æäº¤äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function () {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        });
    </script>
</body>

</html>